<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Blockchain Message Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #333;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0d1117 0%, #1a1f2e 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-bottom: 3px solid #3b82f6;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-subtitle {
            color: #9ca3af;
            font-size: 13px;
            margin-top: 5px;
        }

        .header-stats {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .header-stat {
            text-align: right;
        }

        .header-stat-label {
            font-size: 11px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .header-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-top: 3px;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
        }

        h1 {
            color: #1a1f2e;
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 600;
        }

        .subtitle {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 14px;
        }

        /* Connection Banner */
        .connection-status {
            padding: 12px 20px;
            margin-bottom: 25px;
            font-size: 13px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid;
        }

        .connected {
            background: #ecfdf5;
            color: #065f46;
            border-left-color: #10b981;
        }

        .disconnected {
            background: #fef2f2;
            color: #991b1b;
            border-left-color: #ef4444;
        }

        /* Info Boxes */
        .info-boxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-box {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 24px;
            transition: all 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .info-box:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #3b82f6;
        }

        .info-box-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .info-box-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .info-box-title {
            font-size: 13px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .info-box-value {
            font-size: 32px;
            font-weight: 700;
            color: #1a1f2e;
            margin-bottom: 8px;
        }

        .info-box-subtitle {
            font-size: 13px;
            color: #6b7280;
        }

        .info-box-subtitle a {
            color: #3b82f6;
            text-decoration: none;
        }

        .info-box-subtitle a:hover {
            text-decoration: underline;
        }

        /* Input Section */
        .input-section {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 28px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1f2e;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            font-family: inherit;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        button {
            padding: 12px 28px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        button:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Alerts */
        .status-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
            display: none;
            font-size: 13px;
            border-left: 4px solid;
        }

        .success {
            background: #ecfdf5;
            color: #065f46;
            border-left-color: #10b981;
            display: block;
        }

        .error {
            background: #fef2f2;
            color: #991b1b;
            border-left-color: #ef4444;
            display: block;
        }

        .info {
            background: #eff6ff;
            color: #1e40af;
            border-left-color: #3b82f6;
            display: block;
        }

        .warning-box {
            background: #fffbeb;
            border: 1px solid #fbbf24;
            border-left: 4px solid #f59e0b;
            padding: 14px 16px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-size: 13px;
            color: #92400e;
            display: flex;
            gap: 10px;
            align-items: start;
        }

        /* Messages Section */
        .messages-section {
            margin-top: 30px;
        }

        .messages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .messages-header h2 {
            color: #1a1f2e;
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .messages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            max-height: 700px;
            overflow-y: auto;
            padding: 10px 2px;
        }

        /* Custom Scrollbar */
        .messages-grid::-webkit-scrollbar {
            width: 8px;
        }

        .messages-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .messages-grid::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 10px;
        }

        .messages-grid::-webkit-scrollbar-thumb:hover {
            background: #2563eb;
        }

        .message-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #3b82f6;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .message-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.15);
            border-left-color: #2563eb;
            border-color: #3b82f6;
        }

        .message-id {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .message-content {
            margin-top: 8px;
            margin-bottom: 16px;
        }

        .message-label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .message-hash-preview {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            color: #1a1f2e;
            font-weight: 500;
            font-size: 14px;
            margin: 0 0 16px 0;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            word-break: break-word;
        }

        .message-meta {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }

        .message-meta-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #6b7280;
        }

        .message-meta-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
        }

        .message-meta-value {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            color: #3b82f6;
            font-size: 12px;
        }

        .click-hint {
            text-align: center;
            margin-top: 12px;
            font-size: 11px;
            color: #9ca3af;
            font-weight: 500;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.2s;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, #1a1f2e 0%, #0d1117 100%);
            color: white;
            padding: 24px 30px;
            border-radius: 12px 12px 0 0;
            border-bottom: 3px solid #3b82f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-body {
            padding: 30px;
            background: #f9fafb;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
            padding: 0 8px;
        }

        .close:hover {
            opacity: 1;
        }

        .detail-section {
            margin-bottom: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .detail-label {
            font-weight: 600;
            color: #1a1f2e;
            font-size: 12px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-value {
            background: #f9fafb;
            padding: 14px 16px;
            border-radius: 6px;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            word-break: break-all;
            color: #1a1f2e;
            font-size: 13px;
            border: 1px solid #e5e7eb;
            line-height: 1.6;
        }

        .detail-value.large {
            font-size: 16px;
            font-weight: 500;
        }

        .detail-value strong {
            color: #6b7280;
            font-weight: 600;
        }

        .no-messages {
            text-align: center;
            color: #6b7280;
            padding: 60px 20px;
            font-size: 15px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
        }

        .no-messages-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #3b82f6;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
        }

        .spinner {
            border: 3px solid #e5e7eb;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        /* Copy Button */
        .copy-btn {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: auto;
        }

        .copy-btn:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }

        .copy-btn.copied {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                transform: translateY(-30px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-stats {
                display: none;
            }
            
            .messages-grid {
                grid-template-columns: 1fr;
            }
            
            .info-boxes {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo-section">
                <div>
                    <div class="logo">üîó SuspiciousChain</div>
                    <div class="logo-subtitle">Blockchain Evidence Explorer</div>
                </div>
            </div>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-label">Network</div>
                    <div class="header-stat-value" id="networkStatus">Ganache</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-label">Total Evidence</div>
                    <div class="header-stat-value" id="headerTotalMessages">0</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="connectionStatus" class="connection-status disconnected">
            <span>‚ö†Ô∏è</span>
            <span>Connecting to Ganache blockchain...</span>
        </div>

        <!-- Info Boxes -->
        <div class="info-boxes">
            <div class="info-box">
                <div class="info-box-header">
                    <div class="info-box-icon">üìä</div>
                    <div class="info-box-title">Total Evidence</div>
                </div>
                <div class="info-box-value" id="totalMessages">0</div>
                <div class="info-box-subtitle">Suspicious messages stored on blockchain</div>
            </div>
            <div class="info-box">
                <div class="info-box-header">
                    <div class="info-box-icon">üìú</div>
                    <div class="info-box-title">Smart Contract</div>
                </div>
                <div class="info-box-value" id="contractAddress" style="font-size: 18px; word-break: break-all;">Loading...</div>
                <div class="info-box-subtitle">MessageHashStorage deployed address</div>
            </div>
            <div class="info-box">
                <div class="info-box-header">
                    <div class="info-box-icon">üîê</div>
                    <div class="info-box-title">Security</div>
                </div>
                <div class="info-box-value" style="font-size: 24px;">Immutable</div>
                <div class="info-box-subtitle">Evidence cannot be deleted or modified</div>
            </div>
        </div>

        <!-- Input Section -->
        <div class="input-section">
            <div class="section-title">
                <span>üìù</span>
                <span>Store New Suspicious Message</span>
            </div>
            <div class="warning-box">
                <span>‚ö†Ô∏è</span>
                <div>
                    <strong>Detection Filter Active:</strong> Only messages containing suspicious keywords (drug-related terms) will be stored on the blockchain as evidence. Clean messages will be rejected.
                </div>
            </div>
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="Enter message to analyze and store..." />
                <button id="submitBtn" onclick="storeMessage()">Analyze & Store</button>
            </div>
            <div id="statusMessage" class="status-message"></div>
        </div>

        <!-- Messages Section -->
        <div class="messages-section">
            <div class="messages-header">
                <h2>
                    <span>ÔøΩ</span>
                    <span>Suspicious Message Evidence</span>
                    <span class="badge" id="messageBadge">0</span>
                </h2>
            </div>
            <div id="messagesList" class="messages-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading evidence from blockchain...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Message Details -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîç Evidence Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be dynamically inserted -->
            </div>
        </div>
    </div>

    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = '0x3B2bD66c48FADbcb0E63137B3958018494B9fB0B';
        const GANACHE_URL = 'http://127.0.0.1:7545';
        
        const CONTRACT_ABI = [
            {
                "inputs": [],
                "name": "getAllMessages",
                "outputs": [
                    {
                        "components": [
                            {"internalType": "string", "name": "messageHash", "type": "string"},
                            {"internalType": "string", "name": "originalMessage", "type": "string"},
                            {"internalType": "uint256", "name": "timestamp", "type": "uint256"},
                            {"internalType": "address", "name": "sender", "type": "address"},
                            {"internalType": "string", "name": "senderInfo", "type": "string"}
                        ],
                        "internalType": "struct MessageHashStorage.MessageRecord[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getTotalMessages",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "string", "name": "_messageHash", "type": "string"},
                    {"internalType": "string", "name": "_originalMessage", "type": "string"},
                    {"internalType": "string", "name": "_senderInfo", "type": "string"}
                ],
                "name": "storeMessageHash",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        let web3;
        let contract;
        let accounts;

        // Initialize Web3 and contract
        async function init() {
            try {
                web3 = new Web3(new Web3.providers.HttpProvider(GANACHE_URL));
                
                const isConnected = await web3.eth.net.isListening();
                if (!isConnected) {
                    throw new Error('Cannot connect to Ganache');
                }

                accounts = await web3.eth.getAccounts();
                if (accounts.length === 0) {
                    throw new Error('No accounts found in Ganache');
                }

                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);

                document.getElementById('connectionStatus').className = 'connection-status connected';
                document.getElementById('connectionStatus').innerHTML = `
                    <span>‚úÖ</span>
                    <span>Connected to Ganache | Account: ${accounts[0].substring(0, 10)}...${accounts[0].substring(accounts[0].length - 8)}</span>
                `;
                
                document.getElementById('contractAddress').textContent = CONTRACT_ADDRESS;

                await loadMessages();

            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
                document.getElementById('connectionStatus').innerHTML = `‚ùå Connection failed: ${error.message}`;
                showStatus('Make sure Ganache is running on http://127.0.0.1:7545', 'error');
            }
        }

        // Hash message using SHA-256
        function hashMessage(message) {
            return CryptoJS.SHA256(message).toString(CryptoJS.enc.Hex);
        }

        // Check if message is suspicious (ML model logic)
        function isSuspicious(message) {
            // Suspicious keywords from ML model
            const keywords = ['drug', 'cocaine', 'weed', 'lsd', 'ecstasy', 'heroin', 'meth', 
                              'marijuana', 'cannabis', 'opium', 'fentanyl', 'mdma', 'crack',
                              'methamphetamine', 'amphetamine', 'ketamine', 'pcp'];
            
            const lowerMessage = message.toLowerCase();
            
            // Check if any keyword exists in the message
            for (const keyword of keywords) {
                if (lowerMessage.includes(keyword)) {
                    return true;
                }
            }
            return false;
        }

        // Store message on blockchain
        async function storeMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) {
                showStatus('Please enter a message', 'error');
                return;
            }

            if (!contract || !accounts) {
                showStatus('Not connected to blockchain. Please refresh the page.', 'error');
                return;
            }

            // Check if message is suspicious
            if (!isSuspicious(message)) {
                showStatus('‚ùå Message NOT stored: Not flagged as suspicious. Only suspicious messages are stored on blockchain as evidence.', 'error');
                messageInput.value = '';
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Storing...';

            try {
                const messageHash = hashMessage(message);
                const timestamp = new Date().toISOString();
                const senderInfo = `Web UI | Time: ${timestamp}`;

                showStatus('Sending transaction to blockchain...', 'info');
                
                const receipt = await contract.methods.storeMessageHash(
                    messageHash,
                    message,  // Store original message as evidence
                    senderInfo
                ).send({ 
                    from: accounts[0],
                    gas: 500000
                });

                messageInput.value = '';
                showStatus(`‚úÖ Message stored successfully! Tx: ${receipt.transactionHash.substring(0, 20)}...`, 'success');

                setTimeout(() => loadMessages(), 1000);

            } catch (error) {
                console.error('Error storing message:', error);
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Store on Blockchain';
            }
        }

        // Load all messages from blockchain
        async function loadMessages() {
            if (!contract) return;

            try {
                const code = await web3.eth.getCode(CONTRACT_ADDRESS);
                if (code === '0x' || code === '0x0') {
                    throw new Error('Contract not found at this address.');
                }

                const totalMessages = await contract.methods.getTotalMessages().call();
                document.getElementById('totalMessages').textContent = totalMessages;
                document.getElementById('headerTotalMessages').textContent = totalMessages;
                document.getElementById('messageBadge').textContent = totalMessages;

                if (totalMessages == 0) {
                    displayMessages([]);
                    return;
                }

                const messages = await contract.methods.getAllMessages().call();
                displayMessages(messages);
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messagesList').innerHTML = `
                    <div class="no-messages">
                        ‚ùå Error loading messages: ${error.message}
                    </div>
                `;
            }
        }

        // Display messages in grid
        function displayMessages(messages) {
            const messagesList = document.getElementById('messagesList');

            if (messages.length === 0) {
                messagesList.innerHTML = `
                    <div class="no-messages">
                        <div class="no-messages-icon">üì≠</div>
                        <div style="font-weight: 600; margin-bottom: 8px;">No Evidence Found</div>
                        <div>No suspicious messages have been stored on the blockchain yet.</div>
                    </div>
                `;
                return;
            }

            // Store ORIGINAL messages array globally for modal access (NOT reversed)
            window.messagesData = [...messages];
            
            // Create reversed array for display (newest first)
            const reversedMessages = [...messages].reverse();
            
            messagesList.innerHTML = reversedMessages.map((msg, index) => {
                // Calculate correct IDs
                const originalArrayIndex = messages.length - 1 - index; // Index in ORIGINAL array
                const messageId = originalArrayIndex + 1; // Display ID (1-based)
                
                const date = new Date(msg.timestamp * 1000);
                const formattedDate = date.toLocaleString();
                const messagePreview = msg.originalMessage.length > 80 ? 
                    msg.originalMessage.substring(0, 80) + '...' : 
                    msg.originalMessage;
                
                // Detect keyword for display
                const keyword = detectSuspiciousKeyword(msg.originalMessage);
                
                return `
                    <div class="message-card" onclick="openModalById(${originalArrayIndex})">
                        <div class="message-id">#${messageId}</div>
                        <div class="message-content">
                            <div class="message-label">üö® Suspicious Message</div>
                            <div class="message-hash-preview">"${messagePreview}"</div>
                        </div>
                        <div class="message-meta">
                            <div class="message-meta-item">
                                <span class="message-meta-icon">ÔøΩ</span>
                                <strong>Keyword:</strong> <span style="color: #ef4444; font-weight: 600; text-transform: uppercase;">${keyword}</span>
                            </div>
                            <div class="message-meta-item">
                                <span class="message-meta-icon">ÔøΩüìÖ</span>
                                <span>${formattedDate}</span>
                            </div>
                            <div class="message-meta-item">
                                <span class="message-meta-icon">ÔøΩ</span>
                                <span class="message-meta-value">${msg.sender.substring(0, 10)}...${msg.sender.substring(msg.sender.length - 8)}</span>
                            </div>
                        </div>
                        <div class="click-hint">‚Üí Click to view full evidence details</div>
                    </div>
                `;
            }).join('');
        }

        // Detect which keyword made message suspicious
        function detectSuspiciousKeyword(message) {
            const keywords = ['drug', 'cocaine', 'weed', 'lsd', 'ecstasy', 'heroin', 'meth', 
                              'marijuana', 'cannabis', 'opium', 'fentanyl', 'mdma', 'crack',
                              'methamphetamine', 'amphetamine', 'ketamine', 'pcp'];
            
            const lowerMessage = message.toLowerCase();
            const foundKeywords = [];
            
            for (const keyword of keywords) {
                if (lowerMessage.includes(keyword)) {
                    foundKeywords.push(keyword);
                }
            }
            
            return foundKeywords.length > 0 ? foundKeywords.join(', ') : 'unknown';
        }

        // Open modal by array index
        function openModalById(arrayIndex) {
            if (!window.messagesData || !window.messagesData[arrayIndex]) {
                console.error('Message data not found');
                return;
            }
            
            const msg = window.messagesData[arrayIndex];
            const messageId = arrayIndex + 1; // Convert to 1-based ID
            
            // Extract values properly from the message object
            const messageHash = msg.messageHash || msg[0] || 'N/A';
            const originalMessage = msg.originalMessage || msg[1] || 'N/A';
            const timestamp = msg.timestamp || msg[2] || 0;
            const sender = msg.sender || msg[3] || 'N/A';
            const senderInfo = msg.senderInfo || msg[4] || 'N/A';
            
            // Detect suspicious keyword
            const detectedKeyword = detectSuspiciousKeyword(originalMessage);
            
            const date = new Date(timestamp * 1000);
            const formattedDate = date.toLocaleString();
            const blockDate = date.toUTCString();
            
            // Parse sender info to extract details - Enhanced for multiple formats
            const senderInfoParts = senderInfo.split(' | ');
            let telegramId = 'N/A';
            let phoneNumber = 'Not Available';
            let username = 'Not Available';
            let fullName = 'Not Available';
            let captureTime = 'N/A';
            let dataSource = 'Unknown';
            
            senderInfoParts.forEach(part => {
                if (part.includes('Telegram ID:')) {
                    telegramId = part.replace('Telegram ID:', '').trim();
                    dataSource = 'Telegram (New Format)';
                } else if (part.includes('Sender ID:')) {
                    // Legacy format - Sender ID field
                    telegramId = part.replace('Sender ID:', '').trim();
                    dataSource = 'Telegram (Legacy)';
                } else if (part.includes('Telegram User:')) {
                    // Very old format - Telegram User
                    username = part.replace('Telegram User:', '').trim();
                    telegramId = username;
                    dataSource = 'Telegram (Test Data)';
                } else if (part.includes('Telegram Bot')) {
                    dataSource = 'Telegram Bot';
                } else if (part.includes('Web UI')) {
                    dataSource = 'Web Interface';
                } else if (part.includes('Phone:')) {
                    phoneNumber = part.replace('Phone:', '').trim();
                } else if (part.includes('Username:')) {
                    username = part.replace('Username:', '').trim();
                } else if (part.includes('Name:')) {
                    fullName = part.replace('Name:', '').trim();
                } else if (part.includes('Time:')) {
                    captureTime = part.replace('Time:', '').trim();
                }
            });
            
            document.getElementById('modalBody').innerHTML = `
                <div class="detail-section" style="background: #fef2f2; border-color: #fecaca;">
                    <div class="detail-label" style="color: #991b1b;">
                        <span>üö®</span> DETECTED SUSPICIOUS KEYWORD(S)
                    </div>
                    <div class="detail-value large" style="background: #ef4444; border-color: #dc2626; color: white; font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; text-transform: uppercase;">
                        ${detectedKeyword}
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">
                        <span>üìÑ</span> EVIDENCE ID
                    </div>
                    <div class="detail-value">#${messageId}</div>
                </div>
                
                <div class="detail-section" style="background: #fffbeb; border-color: #fde68a;">
                    <div class="detail-label" style="color: #92400e;">
                        <span>‚ö†Ô∏è</span> ORIGINAL MESSAGE (EVIDENCE)
                    </div>
                    <div class="detail-value large" style="background: white; border-left: 4px solid #f59e0b; color: #1a1f2e; font-family: Arial, sans-serif; font-size: 15px; font-weight: 500;">
                        "${originalMessage}"
                    </div>
                </div>
                
                <div class="detail-section" style="background: #eff6ff; border-color: #bfdbfe;">
                    <div class="detail-label" style="color: #1e40af;">
                        <span>üë§</span> SUSPECT INFORMATION
                    </div>
                    <div class="detail-value" style="background: white;">
                        <strong>üì± Phone Number:</strong> 
                        <span style="color: ${phoneNumber === 'Not Available' ? '#9ca3af' : '#ef4444'}; font-weight: 600; font-size: 15px;">
                            ${phoneNumber}
                        </span>
                        ${phoneNumber === 'Not Available' ? '<span style="color: #6b7280; font-size: 11px;"> (Not captured for this evidence)</span>' : ''}
                        <br>
                        <strong>üÜî Telegram ID:</strong> ${telegramId}<br>
                        <strong>üë§ Username:</strong> ${username}<br>
                        <strong>üìù Full Name:</strong> ${fullName}<br>
                        <strong>üì° Data Source:</strong> <span style="color: #3b82f6; font-size: 12px;">${dataSource}</span>
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">
                        <span>üîê</span> CRYPTOGRAPHIC HASH (SHA-256)
                    </div>
                    <div class="detail-value" style="word-break: break-all; font-size: 12px;">${messageHash}</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">
                        <span>üïê</span> TIMESTAMP INFORMATION
                    </div>
                    <div class="detail-value">
                        <strong>Local Time:</strong> ${formattedDate}<br>
                        <strong>UTC:</strong> ${blockDate}<br>
                        <strong>Unix Timestamp:</strong> ${timestamp}
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">
                        <span>üìç</span> BLOCKCHAIN ADDRESS
                    </div>
                    <div class="detail-value" style="word-break: break-all;">${sender}</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">
                        <span>ÔøΩ</span> RAW SOURCE DATA
                    </div>
                    <div class="detail-value" style="font-size: 11px; color: #6b7280;">${senderInfo}</div>
                </div>
            `;
            
            document.getElementById('messageModal').style.display = 'block';
        }

        // Close modal
        function closeModal() {
            document.getElementById('messageModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('messageModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.className = 'status-message';
                }, 5000);
            }
        }

        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    storeMessage();
                }
            });
        });

        // Initialize on page load
        window.addEventListener('load', init);
    </script>
</body>
</html>
